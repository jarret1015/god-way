<h1 align = "center">延时消息和定时消息</h1>

# 前言

延时消息（定时消息）指的在分布式异步消息场景下，生产端发送一条消息，希望在指定延时或者指定时间点被消费端消费到，而不是立刻被消费。

# 适用场景

- 消息生产和消费有时间窗口要求，例如在电商交易中超时未支付关闭订单的场景，在订单创建时会发送一条延时消息。这条消息将会在30分钟以后投递给消费者，消费者收到此消息后需要判断对应的订单是否已完成支付。如支付未完成，则关闭订单。如已完成支付则忽略。
- 通过消息触发一些定时任务，例如在某一固定时间点向用户发送提醒消息。

# 实现方案

### 1.基于外部存储实现的方案

这里讨论的外部存储指的是在 MQ 本身自带的存储以外又引入的其他的存储系统。

基于外部存储的方案本质上都是一个套路，将 MQ 和 延时模块 区分开来，延时消息模块是一个独立的服务/进程。延时消息先保留到其他存储介质中，然后在消息到期时再投递到 MQ。

当然还有一些细节性的设计，比如消息进入的延时消息模块时已经到期则直接投递这类的逻辑，这里不展开讨论。

![640](..\img\640.png)

下述方案不同的是，采用了不同的存储系统。

#### 基于 数据库（如MySQL）

基于关系型数据库（如MySQL）延时消息表的方式来实现。

```mysql
CREATE TABLE `delay_msg` (
 `id` bigint unsigned NOT NULL AUTO_INCREMENT,
 `delivery_time` DATETIME NOT NULL COMMENT '投递时间',
 `payloads` blob COMMENT '消息内容',
 PRIMARY KEY (`id`),
 KEY `time_index` (`delivery_time`)
)
```

通过定时线程定时扫描到期的消息，然后进行投递。定时线程的扫描间隔理论上就是你延时消息的最小时间精度。

优点：

- 实现简单；

缺点：

- B+Tree索引不适合消息场景的大量写入；